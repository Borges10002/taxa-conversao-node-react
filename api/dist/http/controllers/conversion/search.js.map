{"version":3,"sources":["../../../../src/http/controllers/conversion/search.ts","../../../../src/lib/prisma.ts","../../../../src/env/index.ts","../../../../src/repositories/prisma/prisma-conversion-repository.ts","../../../../src/use-cases/search-conversion.ts","../../../../src/use-cases/factories/make-search-conversion-use-case.ts"],"sourcesContent":["import { makeConversionUseCase } from \"@/use-cases/factories/make-search-conversion-use-case\";\nimport { FastifyReply, FastifyRequest } from \"fastify\";\nimport { string, z } from \"zod\";\n\nexport async function getConversionEvolution(\n  request: FastifyRequest,\n  reply: FastifyReply\n) {\n  const conversionQuerySchema = z.object({\n    channel: string().optional(),\n    status: string().optional(),\n    startDate: string().optional(),\n    endDate: string().optional(),\n  });\n\n  const { channel, endDate, startDate, status } = conversionQuerySchema.parse(\n    request.query\n  );\n\n  const searchConversionUseCase = makeConversionUseCase();\n\n  const { conversion } = await searchConversionUseCase.execute({\n    channel: String(channel),\n    status: String(status),\n    endDate: String(endDate),\n    startDate: String(startDate),\n  });\n\n  const formattedConversions = conversion.map((conversion) => ({\n    ...conversion,\n    date:\n      conversion.date instanceof Date\n        ? conversion.date.toISOString()\n        : conversion.date, // Converte para string ISO se for um objeto Date\n  }));\n\n  return reply.status(200).send({ conversion: formattedConversions });\n}\n","import { PrismaClient } from \"@prisma/client\";\nimport { env } from \"@/env\";\n\nexport const prisma = new PrismaClient({\n  log: env.NODE_ENV === \"dev\" ? [\"query\"] : [],\n});\n","import \"dotenv/config\";\nimport { z } from \"zod\";\n\nconst envSchema = z.object({\n  NODE_ENV: z.enum([\"dev\", \"test\", \"production\"]).default(\"dev\"),\n  JWT_SECRET: z.string(),\n  PORT: z.coerce.number().default(3333),\n});\n\nconst _env = envSchema.safeParse(process.env);\n\nif (_env.success === false) {\n  console.error(\"❌ Invalid environment variables\", _env.error.format());\n\n  throw new Error(\"Invalid environment variables.\");\n}\n\nexport const env = _env.data;\n","import { prisma } from \"@/lib/prisma\";\nimport { Prisma, Event as PrismaEvent } from \"@prisma/client\";\nimport { ConversionRepository } from \"../conversion-repository\";\n\nexport class PrismaConversionRepository implements ConversionRepository {\n  async findById(id: number): Promise<PrismaEvent | null> {\n    const ckeckIn = await prisma.event.findUnique({ where: { id } });\n\n    return ckeckIn;\n  }\n\n  async getConversionRateOverTime(params: {\n    channel?: string | null;\n    status?: string | null;\n    startDate?: string | null;\n    endDate?: string | null;\n  }): Promise<any[]> {\n    const { channel, status, startDate, endDate } = params;\n\n    const whereConditions: string[] = [];\n    const queryParams: any[] = [];\n\n    // Adiciona condições apenas se os valores forem válidos\n    if (channel) {\n      console.log(\"aa\", channel);\n      whereConditions.push(`origin = $${whereConditions.length + 1}`);\n      queryParams.push(channel);\n    }\n\n    if (status !== undefined && status !== null && status !== \"\") {\n      whereConditions.push(\n        `response_status_id = $${whereConditions.length + 1}`\n      );\n      queryParams.push(parseInt(status, 10));\n    }\n\n    if (startDate) {\n      whereConditions.push(\n        `created_at >= $${whereConditions.length + 1}::date`\n      );\n      queryParams.push(startDate);\n    }\n\n    if (endDate) {\n      whereConditions.push(\n        `created_at <= $${whereConditions.length + 1}::date`\n      );\n      queryParams.push(endDate + \" 23:59:59\"); // Inclui todo o dia\n    }\n\n    const whereClause =\n      whereConditions.length > 0\n        ? `WHERE ${whereConditions.join(\" AND \")}`\n        : \"\";\n\n    const sql = `\n      SELECT\n        origin AS channel,\n        DATE_TRUNC('day', created_at) AS date,\n        COUNT(*) FILTER (WHERE response_status_id IN (1, 5, 6)) AS total_sent,\n        COUNT(*) FILTER (WHERE response_status_id = 6) AS total_viewed,\n        ROUND(\n          CASE WHEN COUNT(*) FILTER (WHERE response_status_id IN (1, 5, 6)) > 0\n            THEN COUNT(*) FILTER (WHERE response_status_id = 6)::numeric / \n                COUNT(*) FILTER (WHERE response_status_id IN (1, 5, 6)) * 100\n            ELSE 0\n          END, 2\n        ) AS conversion_rate\n      FROM \"event\" e\n      ${whereClause}\n      GROUP BY channel, date\n      ORDER BY date ASC\n    `;\n\n    return await prisma.$queryRawUnsafe<any[]>(sql, ...queryParams);\n  }\n\n  async create(data: Prisma.EventCreateInput): Promise<PrismaEvent> {\n    const event = await prisma.event.create({ data });\n    return event;\n  }\n}\n","import { ConversionRepository } from \"@/repositories/conversion-repository\";\n\ninterface Request {\n  channel: string;\n  endDate: string;\n  startDate: string;\n  status: string;\n}\n\ninterface SearchConversioUseCaseResponse {\n  conversion: any[];\n}\n\nexport class SearchConversionUseCase {\n  constructor(private conversionRepository: ConversionRepository) {}\n\n  async execute(params: Request): Promise<SearchConversioUseCaseResponse> {\n    const result =\n      await this.conversionRepository.getConversionRateOverTime(params);\n\n    const conversion = result.map((row) => ({\n      channel: row.channel,\n      date: row.date,\n      total_sent: Number(row.total_sent),\n      total_viewed: Number(row.total_viewed),\n      conversion_rate: Number(row.conversion_rate),\n    }));\n\n    return {\n      conversion,\n    };\n  }\n}\n","import { PrismaConversionRepository } from \"@/repositories/prisma/prisma-conversion-repository\";\nimport { SearchConversionUseCase } from \"../search-conversion\";\n\nexport function makeConversionUseCase() {\n  const conversionRepository = new PrismaConversionRepository();\n\n  const useCase = new SearchConversionUseCase(conversionRepository);\n\n  return useCase;\n}\n"],"mappings":"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","names":["import_zod","conversion"]}